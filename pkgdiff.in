#!/bin/sh
# This file is part of pkgmaint.
# See COPYING and COPYRIGHT files for corresponding information.

######################################################################
# Informational helpers.                                             #
######################################################################

fatal() {
	echo >&2 "pkgdiff: $1"
	exit 1
}

######################################################################
# Pkgdiff.                                                           #
######################################################################

pkgdiff() {
	[ -f "$1" ] || fatal "file '$1' not found"
	[ -f "$2" ] || fatal "file '$2' not found"

	# https://tldp.org/LDP/abs/html/exitcodes.html
	# 126 - Command invoked cannot execute.
	TMPFILE1=$(mktemp) || exit 126
	TMPFILE2=$(mktemp) || exit 126

	pkginfo --footprint="$1" > "$TMPFILE1"
	pkginfo --footprint="$2" > "$TMPFILE2"

	# Intentional word splitting for $COLOR.
	# shellcheck disable=2086
	diff $COLOR -d -u "$TMPFILE1" "$TMPFILE2" |
		sed -e "1s,$TMPFILE1,$1,;2s,$TMPFILE2,$2,"
}

######################################################################
# Exit hooks.                                                        #
######################################################################

# Don't warn about unreachable commands in these functions,
# see trap(1p).

# shellcheck disable=2317
atexit() {
	[ -f "$TMPFILE1" ] && rm -f "$TMPFILE1"
	[ -f "$TMPFILE2" ] && rm -f "$TMPFILE2"
}

# shellcheck disable=2317
interrupted() {
	echo >&2 ""
	echo >&2 "=======> Aborted."
	exit 1
}

######################################################################
# Command-line helpers.                                              #
######################################################################

print_help() {
	cat <<EOF
Usage: pkgdiff [OPTION] FILE1 FILE2
Compare software packages' footprints.

  -c, --color     color output
  -v, --version   print version and exit
  -h, --help      print help and exit
EOF
}

print_version() {
	echo "pkgdiff @VERSION@"
}

parse_options() {
	eval set -- "$(
		getopt  -a -n "pkgdiff"          \
			-l "color,version,help"  \
			-o "cvh"                 \
			-- "$@"
	)"
	while true; do
		case $1 in
		-c|  --color) COLOR="--color=always"   ;;
		-v|--version) print_version ; exit 0   ;;
		-h|   --help) print_help    ; exit 0   ;;
		          --) shift         ; break    ;;
		           *) fatal "option error: $1" ;;
		esac
		shift
	done

	PKGLIST=$*

	# Intentional.
	# shellcheck disable=SC2086
	set -- $PKGLIST

	case $# in
	0) fatal "missing arguments"      ;;
	1) fatal "required two arguments" ;;
	2)                                ;;
	*) fatal "too many arguments"     ;;
	esac
}

main() {
	parse_options "$@"

	# Intentional.
	# shellcheck disable=2086
	pkgdiff $PKGLIST

	exit 0
}

######################################################################

# -e: Exit if command return status greater than 0
# -f: Disable globbing *?[]
set -ef

# Set exit hooks.
trap "interrupted" HUP  INT  QUIT  TERM
trap "atexit"      EXIT

# Globals.
export LC_ALL=POSIX
PKGLIST=
COLOR=
TMPFILE1=
TMPFILE2=

main "$@"

# End of file.
