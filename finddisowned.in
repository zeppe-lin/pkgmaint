#!/bin/sh
# This file is part of pkgmaint.
# See COPYING and COPYRIGHT files for corresponding information.

finddisowned() {
	# https://tldp.org/LDP/abs/html/exitcodes.html
	# 126 - Command invoked cannot execute.
	TMPFILE1=$(mktemp) || exit 126
	TMPFILE2=$(mktemp) || exit 126

	echo "Get all known files..." 1>&2

	sort -u "$ROOT/var/lib/pkg/db" > "$TMPFILE1"

	echo "Get paths from config..." 1>&2

	#PATHS=$(xargs < "$(readlink -f "$CONF")")
	while read -r _path; do
		# skip comments and empty lines
		case $_path in \#* | "" ) continue ;; esac

		PATHS="$PATHS $_path"
	done < "$(readlink -f "$CONF")"

	(
	cd "${ROOT:-/}" || exit 1

	# Intentional word splitting for PATHS.
	# shellcheck disable=2086
	find $PATHS \( -type d -printf '%p/\n' -o -print \) |
		sort > "$TMPFILE2"
	)

	comm -23 "$TMPFILE2" "$TMPFILE1"
}

print_help() {
	cat <<EOF
Usage: finddisowned [OPTION]...
Find files that are disowned by package manager.

  -r, --root=PATH     specify an alternative root directory
  -c, --config=FILE   specify an alternative configuration file
  -v, --version       print version and exit
  -h, --help          print help and exit
EOF
}

assert_option_has_arg() {
	if [ ! "$1" ]; then
		echo >&2 "$PROGRAM: option $2 requires an argument"
		exit 1
	fi
}

main() {
	while [ "$1" ]; do
		case $1 in

		-r|--root)
			ROOT=$2
			assert_option_has_arg "$ROOT" "-r/--root"
			shift
			;;
		-r*|--root=*)
			ROOT="$(echo "$1" | sed 's/^-\(-root\|r\)//')"
			assert_option_has_arg "$ROOT" "-r/--root"
			;;

		-c|--config)
			CONF=$2
			assert_option_has_arg "$CONF" "-c/--config"
			shift
			;;
		-c*|--config=*)
			CONF="$(echo "$1" | sed 's/^-\(-config\|c\)//')"
			assert_option_has_arg "$CONF" "-c/--config"
			;;

		-v|--version)
			echo "$PROGRAM (pkgmaint) @VERSION@"
			exit 0
			;;
		-h|--help)
			print_help
			exit 0
			;;

		*)
			echo >&2 "$PROGRAM: invalid option $1"
			exit 1
			;;

		esac
		shift
	done

	CONF=${CONF:-"$ROOT/etc/finddisowned.conf"}
	if [ ! -e "$CONF" ]; then
		echo >&2 "$PROGRAM: can't find $CONF file"
		exit 2
	fi

	finddisowned
}

interrupted() {
	echo >&2 ""
	echo >&2 "=======> Aborted."
	exit 1
}

atexit() {
	[ -f "$TMPFILE1" ] && rm "$TMPFILE1"
	[ -f "$TMPFILE2" ] && rm "$TMPFILE2"
}

trap "interrupted" HUP  INT  QUIT  TERM
trap "atexit"      EXIT

export LC_ALL=POSIX

# Globals.
readonly PROGRAM="${0##*/}"
TMPFILE1=
TMPFILE2=

main "$@"

# vim:cc=72:tw=70
# End of file.
